<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wikipedia Fuzzy Image Browser</title>
<style>
body { font-family: Arial, sans-serif; background: #f8f8f8; padding: 20px; }
h1 { text-align: center; }
textarea, input { width: 100%; font-size: 16px; padding: 10px; margin-bottom: 10px; }
button { margin-top: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
#wrapper { max-width: 900px; margin: auto; }
#results { display: flex; flex-direction: column; align-items: center; margin-top: 25px; gap: 25px; }

.card {
    position: relative; background: #fff; width: 320px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    border-radius: 10px; overflow: hidden; text-align: center; transition: transform 0.2s;
}
.card:hover { transform: scale(1.02); }

.image-container { position: relative; width: 100%; overflow: hidden; }
.image-container img { width: 100%; object-fit: contain; display: block; }

.desc {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: rgba(0,0,0,0.75); color: white; padding: 10px;
    opacity: 0; transition: opacity 0.3s; pointer-events: none;
}
.image-container:hover .desc { opacity: 1; }

.controls { display: flex; justify-content: space-between; padding: 10px 20px 15px; }
.controls button {
    background: #007bff; border: none; color: white; padding: 6px 12px;
    border-radius: 5px; cursor: pointer;
}
.controls button:hover { background: #0056b3; }

.page-desc { text-align: left; padding: 10px; background: #f1f1f1; }
.wikilink { display: block; margin-bottom: 5px; font-weight: bold; color: #007bff; text-decoration: none; }
.wikilink:hover { text-decoration: underline; }
</style>
</head>
<body>
<div id="wrapper">
<h1>Wikipedia Fuzzy Image Browser</h1>

<textarea id="inputText" placeholder="Enter search words separated by comma, dot, or double space"></textarea>
<textarea id="ignoreText" placeholder="Enter words to ignore, separated by comma, dot, or double space"></textarea>
<br>
<button onclick="searchWiki()">Search</button>
<button onclick="clearResults()">Clear</button>

<div id="results"></div>
</div>

<script>
// Cookie helpers
function setCookie(name, value, days=365) {
    const d = new Date();
    d.setTime(d.getTime() + (days*24*60*60*1000));
    document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + ";path=/;expires=" + d.toUTCString();
}

function getCookie(name) {
    const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
    return v ? JSON.parse(decodeURIComponent(v[2])) : null;
}

async function searchWiki() {
    const input = document.getElementById('inputText').value.trim();
    const ignoreInput = document.getElementById('ignoreText').value.trim();

    // --- Parse words ---
    let rawWords = input.split(/(?:,|\.\s*| {2,})+/).map(w => w.trim()).filter(Boolean);
    let ignoreWords = ignoreInput.split(/(?:,|\.\s*| {2,})+/).map(w => w.trim().toLowerCase()).filter(Boolean);

    rawWords = rawWords.filter(w => !ignoreWords.includes(w.toLowerCase()));

    // Enforce max 5 words per phrase
    const words = rawWords.map(w => w.split(/\s+/).slice(0,5).join(' '));

    const resultsDiv = document.getElementById('results');

    // Load cached images
    let cachedImages = getCookie("wikiImages") || {};

    for (const word of words) {
        const card = document.createElement('div');
        card.className = 'card';
        resultsDiv.appendChild(card);

        try {
            // Use fuzzy text search first
            let bestTitle = null;

            const searchRes = await fetch(
                `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(word)}&utf8=&format=json&origin=*&srwhat=text`
            );
            const searchData = await searchRes.json();

            if(searchData.query.search.length > 0) {
                bestTitle = searchData.query.search[0].title;
            } else {
                // Fallback: try direct page summary
                bestTitle = word;
            }

            const summaryRes = await fetch(
                `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(bestTitle)}`
            );
            const summaryData = await summaryRes.json();

            if(summaryData.type === "https://mediawiki.org/wiki/HyperSwitch/errors/not_found") {
                card.innerHTML = `<h3>${word}</h3><p>No result found.</p>`;
                continue;
            }

            bestTitle = summaryData.title; // normalized
            const generalDescText = summaryData.extract || "No description available.";

            // Card title & link
            const wikiLink = document.createElement('a');
            wikiLink.href = summaryData.content_urls.desktop.page;
            wikiLink.textContent = bestTitle;
            wikiLink.target = "_blank";
            wikiLink.className = 'wikilink';
            card.appendChild(wikiLink);

            // General description
            const generalDesc = document.createElement('div');
            generalDesc.className = 'page-desc';
            generalDesc.textContent = generalDescText;
            card.appendChild(generalDesc);

            // Check cached images first
            let images = cachedImages[bestTitle] || [];

            if(images.length === 0) {
                // Get image titles
                const imageRes = await fetch(
                    `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(bestTitle)}&prop=images&format=json&origin=*`
                );
                const imageData = await imageRes.json();
                const page = Object.values(imageData.query.pages)[0];
                const imageTitles = (page.images || []).map(img => img.title).filter(t => /\.(jpg|jpeg|png|gif)$/i.test(t)).slice(0,10);

                images = [];
                for(const imgTitle of imageTitles){
                    const infoRes = await fetch(
                        `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(imgTitle)}&prop=imageinfo&iiprop=url|extmetadata&format=json&origin=*`
                    );
                    const infoData = await infoRes.json();
                    const filePage = Object.values(infoData.query.pages)[0];
                    if(filePage?.imageinfo?.[0]?.url){
                        images.push({
                            url: filePage.imageinfo[0].url,
                            desc: filePage.imageinfo[0].extmetadata?.ImageDescription?.value || ""
                        });
                    }
                }
                // Save to cache
                cachedImages[bestTitle] = images;
                setCookie("wikiImages", cachedImages);
            }

            if(images.length > 0){
                let index = 0;
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container';

                const imgEl = document.createElement('img');
                imgEl.src = images[index].url;
                imgContainer.appendChild(imgEl);

                const descEl = document.createElement('div');
                descEl.className = 'desc';
                descEl.textContent = images[index].desc || "";
                imgContainer.appendChild(descEl);

                const controls = document.createElement('div');
                controls.className = 'controls';

                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'Previous';
                prevBtn.onclick = () => {
                    index = (index - 1 + images.length) % images.length;
                    imgEl.src = images[index].url;
                    descEl.textContent = images[index].desc || "";
                };

                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next';
                nextBtn.onclick = () => {
                    index = (index + 1) % images.length;
                    imgEl.src = images[index].url;
                    descEl.textContent = images[index].desc || "";
                };

                controls.appendChild(prevBtn);
                controls.appendChild(nextBtn);

                card.appendChild(imgContainer);
                card.appendChild(controls);
            }

        } catch(error){
            console.error(error);
            card.innerHTML = `<h3>${word}</h3><p>Error fetching data.</p>`;
        }
    }
}

function clearResults(){
    document.getElementById('results').innerHTML = "";
}
</script>
</body>
</html>
