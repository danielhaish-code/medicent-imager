<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wikipedia Fuzzy Image Browser (with Sub Links)</title>
<style>
body { font-family: Arial, sans-serif; background: #f8f8f8; padding: 20px; }
h1 { text-align: center; }
textarea, input { width: 100%; font-size: 16px; padding: 10px; margin-bottom: 10px; }
button { margin-top: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
#wrapper { max-width: 900px; margin: auto; }
#results { display: flex; flex-direction: column; align-items: center; margin-top: 25px; gap: 25px; }

.card {
  background: #fff; width: 320px; border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  overflow: hidden; text-align: center; transition: transform 0.2s;
}
.card:hover { transform: scale(1.02); }

.image-container { position: relative; width: 100%; overflow: hidden; }
.image-container img { width: 100%; object-fit: contain; display: block; }

.desc {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: rgba(0,0,0,0.75); color: white; padding: 10px;
  opacity: 0; transition: opacity 0.3s; pointer-events: none;
}
.image-container:hover .desc { opacity: 1; }

.controls { display: flex; justify-content: space-between; padding: 10px; }
.controls button {
  background: #007bff; color: white; border: none; border-radius: 5px; padding: 5px 10px;
}
.controls button:hover { background: #0056b3; }

.page-desc { padding: 10px; background: #f1f1f1; }
.wikilink { color: #007bff; text-decoration: none; display: block; margin-bottom: 5px; }
.wikilink:hover { text-decoration: underline; }

.sub-results { margin-top: 10px; border-left: 3px solid #007bff; padding-left: 10px; }

#modalOverlay {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7); justify-content: center; align-items: center;
  z-index: 1000;
}
#modalBox {
  background: #fff; border-radius: 10px; padding: 20px; width: 90%; max-width: 400px;
  display: flex; flex-direction: column; max-height: 80vh;
}
#modalLinks { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; border: 1px solid #ccc; padding: 10px; }
#modalButtons {
  position: sticky; bottom: 0; background: white; text-align: right;
  border-top: 1px solid #ccc; padding-top: 10px;
}
#modalButtons button {
  background: #007bff; color: white; border: none; border-radius: 5px; padding: 8px 12px; margin-left: 5px;
}
</style>
</head>
<body>
<div id="wrapper">
<h1>Wikipedia Fuzzy Image Browser (with Sub Links)</h1>
<textarea id="inputText" placeholder="Enter topics (comma-separated)"></textarea>
<button onclick="searchWiki()">Search</button>
<div id="results"></div>
</div>

<!-- Modal -->
<div id="modalOverlay">
  <div id="modalBox">
    <h2>Select sub-links to scrape</h2>
    <div id="modalLinks"></div>
    <div id="modalButtons">
      <button id="scrapeSelectedBtn">Scrape Selected</button>
      <button id="cancelBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
let currentParentCard = null;

// üîç Main search/scrape logic
async function searchWiki(input, parentCard = null) {
  const query = typeof input === "string" ? input : document.getElementById("inputText").value.trim();
  if (!query) return console.log("‚ö†Ô∏è No input provided.");

  const words = query.split(/[,]+/).map(w => w.trim()).filter(Boolean);
  console.log("üîç Searching for:", words);

  const results = document.getElementById("results");

  for (const word of words) {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h3>üîé Loading: ${word}</h3>`;

    if (parentCard) {
      let sub = parentCard.querySelector(".sub-results");
      if (!sub) {
        sub = document.createElement("div");
        sub.className = "sub-results";
        parentCard.appendChild(sub);
      }
      sub.appendChild(card);
    } else {
      results.appendChild(card);
    }

    try {
      // Summary API
      const summaryRes = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(word)}`);
      const summaryData = await summaryRes.json();
      if (!summaryData.title) {
        card.innerHTML = `<p>No page found for ${word}</p>`;
        continue;
      }

      card.innerHTML = `
        <a class="wikilink" href="${summaryData.content_urls.desktop.page}" target="_blank">${summaryData.title}</a>
        <div class="page-desc">${summaryData.extract || "(no summary)"}</div>
      `;

      // Image query
      const imageRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(summaryData.title)}&prop=images&format=json&origin=*`);
      const imageData = await imageRes.json();
      const page = Object.values(imageData.query.pages)[0];
      const imageTitles = (page.images || []).map(img => img.title).filter(t => /\.(jpg|jpeg|png|gif)$/i.test(t)).slice(0,10);

      const images = [];
      for (const imgTitle of imageTitles) {
        const infoRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(imgTitle)}&prop=imageinfo&iiprop=url|extmetadata&format=json&origin=*`);
        const infoData = await infoRes.json();
        const filePage = Object.values(infoData.query.pages)[0];
        if (filePage?.imageinfo?.[0]?.url) {
          images.push({
            url: filePage.imageinfo[0].url,
            desc: filePage.imageinfo[0].extmetadata?.ImageDescription?.value || ""
          });
        }
      }

      // Display image (if any)
      if (images.length > 0) {
        let index = 0;
        const imgContainer = document.createElement("div");
        imgContainer.className = "image-container";

        const imgEl = document.createElement("img");
        imgEl.src = images[index].url;
        imgContainer.appendChild(imgEl);

        const descEl = document.createElement("div");
        descEl.className = "desc";
        descEl.textContent = images[index].desc || "";
        imgContainer.appendChild(descEl);

        const controls = document.createElement("div");
        controls.className = "controls";

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Previous";
        prevBtn.onclick = () => {
          index = (index - 1 + images.length) % images.length;
          imgEl.src = images[index].url;
          descEl.textContent = images[index].desc || "";
        };

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.onclick = () => {
          index = (index + 1) % images.length;
          imgEl.src = images[index].url;
          descEl.textContent = images[index].desc || "";
        };

        const subBtn = document.createElement("button");
        subBtn.textContent = "Add Sub Links";
        subBtn.onclick = () => showSubLinkChooser(summaryData.title, card);

        controls.appendChild(prevBtn);
        controls.appendChild(nextBtn);
        controls.appendChild(subBtn);

        card.appendChild(imgContainer);
        card.appendChild(controls);
      } else {
        // No image found ‚Üí still show Add Sub Links
        const subBtn = document.createElement("button");
        subBtn.textContent = "Add Sub Links";
        subBtn.onclick = () => showSubLinkChooser(summaryData.title, card);
        card.appendChild(subBtn);
      }

    } catch (err) {
      console.error("‚ùå Error fetching:", word, err);
      card.innerHTML = `<p>Error loading ${word}</p>`;
    }
  }
}

// üß© Sub-link modal logic
async function showSubLinkChooser(title, parentCard) {
  console.log("ü™Ñ Fetching sublinks for:", title);
  try {
    const res = await fetch(`https://en.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=links&format=json&origin=*`);
    const data = await res.json();

    if (!data.parse?.links) {
      alert("No sub-links found for this page.");
      return;
    }

    const subLinks = data.parse.links.filter(l => !l["*"].includes(":")).map(l => l["*"]);
    console.log("‚úÖ Found sublinks:", subLinks);

    const modal = document.getElementById("modalOverlay");
    const modalLinks = document.getElementById("modalLinks");
    modalLinks.innerHTML = "";

    subLinks.forEach(link => {
      const div = document.createElement("div");
      div.innerHTML = `<label><input type="checkbox" value="${link}"> ${link}</label>`;
      modalLinks.appendChild(div);
    });

    currentParentCard = parentCard;
    modal.style.display = "flex";
  } catch (err) {
    console.error("‚ùå Error loading sublinks:", err);
  }
}

document.getElementById("scrapeSelectedBtn").addEventListener("click", async () => {
  const modalLinks = document.getElementById("modalLinks");
  const selected = Array.from(modalLinks.querySelectorAll("input:checked")).map(i => i.value);
  console.log("üü¢ Scrape Selected:", selected);
  closeModal();

  if (selected.length > 0 && currentParentCard) {
    await searchWiki(selected.join(","), currentParentCard);
  }
});

document.getElementById("cancelBtn").addEventListener("click", closeModal);

function closeModal() {
  document.getElementById("modalOverlay").style.display = "none";
}
</script>
</body>
</html>
